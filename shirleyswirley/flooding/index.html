<!DOCTYPE html>
<meta charset="utf-8">
<html>
<style>

body {
	font-family: sans-serif;
	font-size: 20px;
}

.axis path,
.axis line {
	fill: none;
	stroke: black;
	shape-rendering: crispEdges;
}

.line {
	fill: none;
	/* stroke: black; */
	stroke-width: 3px;
}

.legend {
        font-size: 16px;         
        font-weight: bold;         
        text-anchor: start;
}

</style>

<body>
<script src="//d3js.org/d3.v3.min.js" charset="utf=8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mousetrap/1.4.6/mousetrap.js" charset="utf-8"></script>
<script>

var margin = {top:40, right:20, bottom:10, left:50};
var width = {image: 720, plot:720*2-30, total: 720*2};
var height = {image: 480, plot:480};

var defs = d3.select("body")
        .append("svg")
	.attr("class", "defs")
	.attr("x",0)
	.attr("y",0)
	.attr("width",0)
	.attr("height",0)
	.append("defs");

defs.append("image")
	.attr("id", "satellite")
	.attr("xlink:href", "flooding_allyears.png")
	.attr("width", width.image*4)
	.attr("height", height.image*5);

defs.append("clipPath")
	.attr("id", "flooding-cp")
	.append("rect")
	.attr("x",0)
	.attr("y",0)
	.attr("height", height.image)
	.attr("width", width.image);

var before = d3.select("body")
	.append("svg")
	.attr("id", "before")
	.attr("width", width.image)
	.attr("height", height.image)
	.attr("x",0)
	.attr("y",0);

var after = d3.select("body")
	.append("svg")
	.attr("id", "after")
	.attr("width", width.image)
	.attr("height", height.image)
	.attr("x", width.image)
	.attr("y",0);

var x = d3.time.scale()
	.range([0,width.plot - margin.left - margin.right]);

var yl = d3.scale.linear()
	.range([height.plot - margin.top - margin.bottom, margin.top]);
        
var yg = d3.scale.linear()
	.range([height.plot - margin.top - margin.bottom, margin.top]);

var x_axis = d3.svg.axis()
	.scale(x)
	.orient("bottom");

var y_axisl = d3.svg.axis()
	.scale(yl)
	.orient("left");
        
var y_axisg = d3.svg.axis()
	.scale(yg)
	.orient("right");

var linel = d3.svg.line()
	.x(function(d) { return x(d.date); })
	.y(function(d) { return yl(d.fakelocaldata); });
        
var lineg = d3.svg.line()
	.x(function(d) { return x(d.date); })
	.y(function(d) { return yg(d.fakeglobaldata); });

var svg = d3.select("body")
	.append("svg")
	.attr("id", "plot")
	.attr("width", width.total)
	.attr("height", height.plot)
	.attr("x",0)
	.attr("y",height.image);

svg.append("text")
	.attr("class", "x label")
	.attr("id", "label")
	.attr("text-anchor", "middle")
	.attr("x", (width.plot)/2)
	.attr("y", height.plot - margin.bottom/3)
	.text("Year")
	.style("font-weight", "bold");

svg.append("text")
	.attr("class", "y label")
	.attr("id", "label")
	.attr("text-anchor", "middle")
	.attr("transform", "translate("+margin.left/3+","+(height.plot-margin.top-margin.bottom)/2+")rotate(-90)")
	.text("Flooding (m)")
	.style("font-weight", "bold");

// Define global variables for keyboard and mouse input
var alldots = null;
var activeidx = 0;
var activemouse = null;

d3.csv("flooding_alt.csv", function(data) {

	var parseDate = d3.time.format("%m/%d/%Y").parse;

	data.forEach(function(d) {
		d.fakelocaldata = +d.fakelocaldata;
		d.fakeglobaldata = +d.fakeglobaldata;
		d.date = parseDate(d.date);
		d.x = +d.x;
		d.y = +d.y;
	});

        // console.log(data);})

	defs.selectAll("g")
		.data(data).enter()
		.append("g")
			.attr("id", function(d) { return d.date.getFullYear(); })
			.attr("clip-path", "url(#flooding-cp)")
		.append("use")
			.attr("xlink:href", "#satellite")
			.attr("transform", function(d) { return "translate("+d.x+","+d.y+")"; });

	x.domain(d3.extent(data, function(d) { return d.date; }));
	yl.domain(d3.extent(data, function(d) { return d.fakelocaldata; }));
	yg.domain(d3.extent(data, function(d) { return d.fakeglobaldata; }));

	svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(" + margin.left + "," + [height.plot - margin.top - margin.bottom] + ")")
		.call(x_axis);

	svg.append("g")
                .attr("class", "y axis")
                .style("fill", "ForestGreen")
                .attr("id", "localAxis")
		.attr("transform", "translate(" + margin.left + ",0)")
		.call(y_axisl);

	svg.append("g")
                .attr("class", "y axis")
                .style("fill", "OrangeRed")
		.style("opacity", 0)
		.attr("id", "globalAxis")
		.attr("transform", "translate(" + width.plot + ",0)")
                .call(y_axisg);

	svg.append("path")
		.datum(data)
                .attr("class", "line")
                .attr("stroke", "ForestGreen")
                .attr("id","localLine")
		.attr("transform", "translate(" + margin.left + ",0)")
		.attr("d",linel);

	svg.append("path")
		.datum(data)
                .attr("class", "line")
                .style("stroke", "OrangeRed")
		.style("opacity", 0)
		.attr("id", "globalLine")
		.attr("transform", "translate(" + margin.left + ",0)")
                .attr("d",lineg);

	// Add local data legend title
        svg.append("text")
		.attr("x", 0)
		.attr("y", height.plot)
		.attr("class", "legend")
		.style("fill", "ForestGreen")
		/*.on("click", function() {
		    // Determine if current line is visible
		    var activeline = localLine.active ? false : true,
			newOpacity = activeline ? 0 : 1;
		    // Hide or show the elements
		    d3.select("#localLine").style("opacity", newOpacity);
		    d3.select("#localAxis").style("opacity", newOpacity);
		    // Update whether or not the elements are active
		    localLine.active = activeline;
		})*/
		.text("Local time series");
	
	// Add global data legend title (clickable to appear/disappear)
        svg.append("text")
		.attr("x", 300)
		.attr("y", height.plot)
		.attr("class", "legend")
		.style("fill", "OrangeRed")
                .style("cursor", "pointer")
		.on("click", function() {
		    // Determine if current line is visible
		    var activeline = globalLine.active ? false : true,
			newOpacity = activeline ? 0 : 1;
		    // Hide or show the elements
		    d3.select("#globalLine").style("opacity", newOpacity);
		    d3.select("#globalAxis").style("opacity", newOpacity);
		    // Update whether or not the elements are active
		    globalLine.active = activeline;
		})
		.text("Global time series");

	var dots = svg.selectAll("circle")
			.data(data).enter()
		.append("circle")
			.attr("id", function(d) { return "y" + d.date.getFullYear(); })
			.attr("cx", function(d) { return x(d.date); })
			.attr("cy", function(d) { return yl(d.fakelocaldata); })
			.attr("transform", "translate("+margin.left+",0)")
			.attr("r", "10px")
			.style("stroke", "black")
			.style("stroke-width", "3px")
			.style("fill", "white");

	d3.select("circle#y1984").style("fill", "steelblue");
	d3.select("circle#y2015").style("fill", "steelblue");

	var before = d3.select("#before")
		.append("svg")
			.attr("viewBox", "0 0 " + width.image + " " + height.image)
			.style("display", "inline")
			.style("height", "1em")
			.style("width", (width.image/height.image) + "em")
		.append("use")
			.attr("id", "image1")
			.attr("xlink:href", "#1984");

	var after = d3.select("#after")
		.append("svg")
			.attr("viewBox", "0 0 " + width.image + " " + height.image)
			.style("display", "inline")
			.style("height", "1em")
			.style("width", (width.image/height.image) + "em")
		.append("use")
			.attr("id", "image2")
			.attr("xlink:href", "#2015");

	d3.select("#before")
		.append("text")
		.attr("id", "before-text")
		.text("1984")
		.attr("x",10)
		.attr("y",30)
		.style("font-size", "24px")
		.style("fill","white");

	d3.select("#after")
		.append("text")
		.text("2015")
		.attr("x",10)
		.attr("y",30)
		.style("font-size", "24px")
		.style("fill","white");

        alldots = d3.selectAll("circle");

        //--------------------
        // MOUSE INTERACTIVITY
        //--------------------
        dots.on({
		mouseover: function(d) {
                    d3.select(this).style("fill", "steelblue");
                    this.style.cursor = "pointer";
		},
		mouseout: function(d) {
			if (this != activemouse) {
				d3.select(this).style("fill", "white");
			}
		},
		click: function(d) {
			d3.selectAll("circle").style("fill", "white");
			d3.select("circle#y2015").style("fill", "steelblue"); // this is needed to keep last dot blue after clicking on it
			activemouse = this;
                        activeidx = findindexbyid(alldots,activemouse.id); 
                        d3.select(activemouse).style("fill", "steelblue");
			d3.select("use#image1").attr("xlink:href", "#" + activemouse.id.substring(1,5));
                        d3.select("#before-text").text(activemouse.id.substring(1,5));
                        d3.select("#timeline-text").text(activemouse.timelinetext);
		}

	});

        //---------------------------------
        // RIGHT-LEFT ARROW KEY STEPTHROUGH
        //---------------------------------
        d3.select("body").on({
		keydown: function(d,i) {
			if (d3.event.keyCode == 39) { // when you click the right arrow key...
                            if (activeidx<alldots.size()-1) {activeidx++;} // don't go further right than there are pts
                            d3.selectAll("circle").style("fill", "white");
                            d3.select("circle#y2015").style("fill", "steelblue");
                            d3.select(alldots[0][activeidx]).style("fill", "steelblue");
			    d3.select("use#image1").attr("xlink:href", "#" + alldots[0][activeidx].id.substring(1,5));
			    d3.select("#before-text").text(alldots[0][activeidx].id.substring(1,5));
                        }
			if (d3.event.keyCode == 37) { // when you click the left arrow key...
                            if (activeidx>0) {activeidx--;} // don't go further left than there are pts
                            d3.selectAll("circle").style("fill", "white");
                            d3.select("circle#y2015").style("fill", "steelblue");
                            d3.select(alldots[0][activeidx]).style("fill", "steelblue");
			    d3.select("use#image1").attr("xlink:href", "#" + alldots[0][activeidx].id.substring(1,5));
			    d3.select("#before-text").text(alldots[0][activeidx].id.substring(1,5));
                        }
		}
	});

});

//-----------------
// DEFINE FUNCTIONS
//-----------------
function findindexbyid(arraytosearch, idtosearch) {
    for (var i = 0; i < arraytosearch.size(); i++) {
        if (arraytosearch[0][i].id == idtosearch) {
        return i;
        }
    }
    return null;
}

</script>
</body>
</html>

